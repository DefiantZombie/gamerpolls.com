<h1>{{poll.question}}</h1>
<div id="chart-container"></div>

<ol>
	{{#poll.answers}}
	<li>
		{{text}} = <span id="answer-{{_id}}">{{votes}}</span> votes
		<div class="progress">
        	<div class="progress-bar" data-answer-id="{{_id}}" style="width: {{percentage}}%;"></div>
    	</div>
	</li>
	{{/poll.answers}}
</ol>

{{#yield-scripts}}
<script src="http://code.highcharts.com/highcharts.js"></script>
<script>
	$(function () {
		$('#chart-container').highcharts({
			chart: {
				type: 'pie',
				backgroundColor: null
			},
			credits: { enabled: false },
			title: { text: '' },
			plotOptions: {
				pie: {
					borderColor: '#000',
					dataLabels: {
						distance: -35,
						backgroundColor: 'rgba(0, 0, 0, 0.5)',
						borderRadius: '5px'
					}
				}
			},
			series: [{
				type: 'pie',
				name: 'Votes',
				data: [
					{{#poll.answers}}
					{
						id: '{{_id}}',
						name: '{{text}}',
						y: {{votes}}
					},
					{{/poll.answers}}
				],
				dataLabels: {
					useHTML: true,
					formatter: function() {
						return '<div class="chart-label">' + (this.point.name.length > 15 ? this.point.name.substr(0, 15).trim() + '...' : this.point.name) + '<br/><span class="chart-label-percent">' + Highcharts.numberFormat(this.percentage, 0) + '%</span></div>';
					}
				}
			}],
			tooltip: {
				useHTML: true,
				headerFormat: '<span class="chart-tooltip-header">{point.key}</span><br><hr>'
			}
		});

		var chart = $('#chart-container').highcharts();

		// Gets answer color from chart and set progress bar color to match
		var data = chart.series[0].data;
		data.forEach(function (answer) {
			$('.progress-bar[data-answer-id="' + answer.id + '"]').css('background-color', answer.color);
		});

		var socket = utils.getSocket();
		socket.on('vote', function (data) {
			data.forEach(function (answer) {
				// Update chart values.
				chart.get(answer._id).update(answer.votes);

				// Update DOM nodes.
				$('#answer-' + answer._id).text(answer.votes);
				$('.progress-bar[data-answer-id="' + answer._id + '"]').css('width', answer.percentage + '%');
			});
		});

	});
</script>
{{/yield-scripts}}
